<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Customer Management</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; }
        .total-credit { font-size: 1.5em; font-weight: bold; color: #d9534f; }
        .customer-list { margin-top: 20px; border-collapse: collapse; width: 100%; }
        .customer-list th, .customer-list td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .customer-list th { background-color: #f2f2f2; }
        .add-form { margin-top: 20px; padding: 15px; border: 1px solid #ddd; background: #f9f9f9; }
        .flashes { color: red; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Customer Management</h1>
        <div>
            <span>Welcome, {{ session['username'] }}</span> |
            <a href="/logout">Logout</a>
        </div>
    </div>

    <div class="total-credit" id="total-credit-display">
        Total Credit: ${{ "%.2f"|format(total_credit) }}
    </div>

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <ul class=flashes>
        {% for message in messages %}
          <li>{{ message }}</li>
        {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <div class="add-form">
        <h3>Add New Customer</h3>
        <form action="/add_customer" method="POST">
            <label for="name">Customer Name:</label>
            <input type="text" id="name" name="name" required>

            <label for="mobile">Mobile Number (9 digits):</label>
            <input type="text" id="mobile" name="mobile" pattern="\d{9}" title="Exactly 9 digits" required>

            <label for="initial_credit">Initial Credit ($):</label>
            <input type="number" id="initial_credit" name="initial_credit" step="0.01" value="0">

            <button type="submit">Add Customer</button>
        </form>
    </div>

    <h3>Customer List</h3>
    <table class="customer-list">
        <thead>
            <tr>
                <th>Customer Name</th>
                <th>Mobile Number</th>
                <th>Credit Balance</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for customer in customers %}
            <tr id="customer-{{ customer.id }}">
                <td>{{ customer.name }}</td>
                <td>{{ customer.mobile }}</td>
                <td class="credit-balance" data-id="{{ customer.id }}">${{ "%.2f"|format(customer.credit_balance) }}</td>
                <td>
                    <input type="number" id="payment-amount-{{ customer.id }}" placeholder="Amount" step="0.01" style="width: 80px;">
                    <button onclick="addPayment({{ customer.id }})">Add Payment</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
        async function addPayment(customerId) {
            const amountInput = document.getElementById(`payment-amount-${customerId}`);
            const amount = parseFloat(amountInput.value);

            if (!amount || amount <= 0) {
                alert("Please enter a valid amount.");
                return;
            }

            try {
                const response = await fetch(`/add_payment/${customerId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ amount: amount })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Update credit balance for the customer
                    const balanceCell = document.querySelector(`.credit-balance[data-id='${customerId}']`);
                    if (balanceCell) {
                        balanceCell.textContent = `$${data.new_balance.toFixed(2)}`;
                    }

                    // Update total credit display
                    const totalCreditDisplay = document.getElementById('total-credit-display');
                    if (totalCreditDisplay) {
                        totalCreditDisplay.textContent = `Total Credit: $${data.total_credit.toFixed(2)}`;
                    }

                    // Clear input
                    amountInput.value = '';
                    alert("Payment recorded successfully!");
                } else {
                    alert(data.error || "An error occurred.");
                }
            } catch (error) {
                console.error("Error:", error);
                alert("Failed to connect to the server.");
            }
        }
    </script>
</body>
</html>